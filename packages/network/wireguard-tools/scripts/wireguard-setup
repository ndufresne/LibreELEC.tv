#!/bin/sh

# SPDX-License-Identifier: GPL-2.0-or-later
# Copyright (C) 2018-present Team LibreELEC (https://libreelec.tv)

umask 077

if [ ! -f /storage/.cache/wireguard/privatekey ]; then
  INT_PRIVATEKEY=$(wg genkey)
  echo "$INT_PRIVATEKEY" > /storage/.cache/wireguard/privatekey
fi

if [ ! -f /storage/.cache/wireguard/publickey ]; then
  INT_PUBLICKEY=$(wg pubkey < /storage/.cache/wireguard/privatekey)
  echo "$INT_PUBLICKEY" > /storage/.cache/wireguard/publickey
fi

if [ ! -f /storage/.cache/wireguard/preshared ]; then
  INT_PRESHAREDKEY=$(wg genpsk)
  echo "$INT_PRESAHAREDKEY" > /storage/.cache/wireguard/preshared
fi

WAN_CIDR=$(curl -4 https://icanhazip.com)

cp -a /usr/config/wireguard.conf.sample /storage/.config
  sed -i 's|@@INT_PRIVATEKEY@@|$INT_PRIVATEKEY|g' /storage/.config/wireguard.conf.sample
  sed -i 's|@@INT_PUBLICKEY@@|$INT_PUBLICKEY|g' /storage/.config/wireguard.conf.sample
  sed -i 's|@@INT_PRESHAREDKEY@@|$INT_PRESHAREDKEY|g' /storage/.config/wireguard.conf.sample
  sed -i 's|@@WAN_CIDR@@|$WAN_CIDR/32|g' /storage/.config/wireguard.conf.sample

if [ -f /storage/.config/wireguard.conf ]; then
  ip link add dev wg0 type wireguard
  wg setconf wg0 /storage/.config/wireguard.conf
fi
