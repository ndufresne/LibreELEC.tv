From c1f754855ad05cda9b0896b01701259a9224bd09 Mon Sep 17 00:00:00 2001
From: Alyssa Rosenzweig <alyssa@rosenzweig.io>
Date: Sat, 10 Nov 2018 20:13:02 -0800
Subject: [PATCH 100/151] blend: Hot patch with dynamic blend shader

---
 src/gallium/drivers/panfrost/nir_lower_blend.c   | 4 ++--
 src/gallium/drivers/panfrost/nir_lower_blend.h   | 2 +-
 src/gallium/drivers/panfrost/pan_blend_shaders.c | 2 +-
 3 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/src/gallium/drivers/panfrost/nir_lower_blend.c b/src/gallium/drivers/panfrost/nir_lower_blend.c
index bf5c5b6..07e3526 100644
--- a/src/gallium/drivers/panfrost/nir_lower_blend.c
+++ b/src/gallium/drivers/panfrost/nir_lower_blend.c
@@ -154,7 +154,7 @@ nir_blend_f(nir_builder *b, const struct pipe_rt_blend_state *blend, nir_ssa_def
 #endif
 
 static void
-nir_per_channel_blending_f(struct pipe_rt_blend_state *blend, nir_builder *b, nir_ssa_def **result,
+nir_per_channel_blending_f(const struct pipe_rt_blend_state *blend, nir_builder *b, nir_ssa_def **result,
                   nir_ssa_def **src_color, nir_ssa_def **dst_color, nir_ssa_def *con)
 {
         if (!blend->blend_enable) {
@@ -193,7 +193,7 @@ nir_per_channel_blending_f(struct pipe_rt_blend_state *blend, nir_builder *b, ni
 /* Arguments are vec4s */
 
 nir_ssa_def *
-nir_blending_f(struct pipe_rt_blend_state *blend, nir_builder *b,
+nir_blending_f(const struct pipe_rt_blend_state *blend, nir_builder *b,
                   nir_ssa_def *src_color, nir_ssa_def *dst_color,
                   nir_ssa_def *constant)
 {
diff --git a/src/gallium/drivers/panfrost/nir_lower_blend.h b/src/gallium/drivers/panfrost/nir_lower_blend.h
index 3d94bcb..f6afcf8 100644
--- a/src/gallium/drivers/panfrost/nir_lower_blend.h
+++ b/src/gallium/drivers/panfrost/nir_lower_blend.h
@@ -23,6 +23,6 @@
  */
 
 nir_ssa_def *
-nir_blending_f(struct pipe_rt_blend_state *blend, nir_builder *b,
+nir_blending_f(const struct pipe_rt_blend_state *blend, nir_builder *b,
                   nir_ssa_def *src_color, nir_ssa_def *dst_color,
                   nir_ssa_def *constant);
diff --git a/src/gallium/drivers/panfrost/pan_blend_shaders.c b/src/gallium/drivers/panfrost/pan_blend_shaders.c
index d0ba50a..ed3fb2d 100644
--- a/src/gallium/drivers/panfrost/pan_blend_shaders.c
+++ b/src/gallium/drivers/panfrost/pan_blend_shaders.c
@@ -147,6 +147,7 @@ panfrost_make_blend_shader(struct panfrost_context *ctx, struct panfrost_blend_s
         fread(dst, 1, 2816, fp);
         fclose(fp);
         int size = 2816;
+#endif
 
         /* Hot patch in constant color */
 
@@ -156,7 +157,6 @@ panfrost_make_blend_shader(struct panfrost_context *ctx, struct panfrost_blend_s
                 for (int c = 0; c < 4; ++c)
                         hot_color[c] = blend_color->color[c];
         }
-#endif
 
         *out = panfrost_upload(&ctx->shaders, dst, size, true) | program.first_tag;
 
-- 
2.7.4

