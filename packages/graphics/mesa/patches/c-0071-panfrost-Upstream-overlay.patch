From 3d7754b058d050bc680ff7216d5c90282950fd44 Mon Sep 17 00:00:00 2001
From: Alyssa Rosenzweig <alyssa@rosenzweig.io>
Date: Sat, 20 Oct 2018 09:44:18 -0700
Subject: [PATCH 071/151] panfrost: Upstream overlay

---
 meson.build                                        |  4 +++-
 meson_options.txt                                  |  2 +-
 src/egl/drivers/dri2/platform_x11.c                |  2 +-
 .../auxiliary/pipe-loader/pipe_loader_drm.c        | 10 ++++++++++
 src/gallium/auxiliary/target-helpers/drm_helper.h  | 23 ++++++++++++++++++++++
 .../auxiliary/target-helpers/drm_helper_public.h   |  6 ++++++
 .../auxiliary/target-helpers/inline_sw_helper.h    | 11 +++++++++++
 src/gallium/auxiliary/target-helpers/sw_helper.h   | 11 +++++++++++
 src/gallium/meson.build                            | 11 +++++++++++
 src/gallium/targets/dri/meson.build                |  4 +++-
 src/gallium/targets/dri/target.c                   | 10 ++++++++++
 src/glx/drisw_glx.c                                |  2 +-
 12 files changed, 91 insertions(+), 5 deletions(-)

diff --git a/meson.build b/meson.build
index 7b1e3f5..9c09dff 100644
--- a/meson.build
+++ b/meson.build
@@ -135,7 +135,7 @@ if _drivers.contains('auto')
       _drivers = [
         'pl111', 'v3d', 'vc4', 'freedreno', 'etnaviv', 'imx', 'nouveau',
         'tegra', 'virgl', 'lima', 'exynos', 'sun4i', 'meson', 'rockchip',
-        'swrast',
+        'swrast', 'panfrost', 'rockchip'
       ]
     else
       error('Unknown architecture @0@. Please pass -Dgallium-drivers to set driver options. Patches gladly accepted to fix this.'.format(
@@ -157,6 +157,8 @@ with_gallium_freedreno = _drivers.contains('freedreno')
 with_gallium_softpipe = _drivers.contains('swrast')
 with_gallium_vc4 = _drivers.contains('vc4')
 with_gallium_v3d = _drivers.contains('v3d')
+with_gallium_panfrost = _drivers.contains('panfrost')
+with_gallium_rockchip = _drivers.contains('rockchip')
 with_gallium_etnaviv = _drivers.contains('etnaviv')
 with_gallium_imx = _drivers.contains('imx')
 with_gallium_tegra = _drivers.contains('tegra')
diff --git a/meson_options.txt b/meson_options.txt
index 8b60af0..f5529ed 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -60,7 +60,7 @@ option(
   choices : [
     '', 'auto', 'pl111', 'radeonsi', 'r300', 'r600', 'nouveau', 'freedreno',
     'swrast', 'v3d', 'vc4', 'etnaviv', 'imx', 'tegra', 'i915', 'svga', 'virgl',
-    'lima', 'exynos', 'sun4i', 'meson', 'rockchip', 'swr',
+    'lima', 'exynos', 'sun4i', 'meson', 'rockchip', 'swr', 'panfrost', 'rockchip'
   ],
   description : 'List of gallium drivers to build. If this is set to auto all drivers applicable to the target OS/architecture will be built'
 )
diff --git a/src/egl/drivers/dri2/platform_x11.c b/src/egl/drivers/dri2/platform_x11.c
index 22bd274..edc50ed 100644
--- a/src/egl/drivers/dri2/platform_x11.c
+++ b/src/egl/drivers/dri2/platform_x11.c
@@ -1292,7 +1292,7 @@ dri2_initialize_x11_swrast(_EGLDriver *drv, _EGLDisplay *disp)
     * Every hardware driver_name is set using strdup. Doing the same in
     * here will allow is to simply free the memory at dri2_terminate().
     */
-   dri2_dpy->driver_name = strdup("swrast");
+   dri2_dpy->driver_name = strdup("panfrost");
    if (!dri2_load_driver_swrast(disp))
       goto cleanup;
 
diff --git a/src/gallium/auxiliary/pipe-loader/pipe_loader_drm.c b/src/gallium/auxiliary/pipe-loader/pipe_loader_drm.c
index fc98d49..a45df9c 100644
--- a/src/gallium/auxiliary/pipe-loader/pipe_loader_drm.c
+++ b/src/gallium/auxiliary/pipe-loader/pipe_loader_drm.c
@@ -112,6 +112,11 @@ static const struct drm_driver_descriptor driver_descriptors[] = {
         .configuration = pipe_default_configuration_query,
     },
     {
+       .driver_name = "rockchip",
+        .create_screen = pipe_rockchip_create_screen,
+        .configuration = pipe_default_configuration_query,
+    },
+    {
         .driver_name = "virtio_gpu",
         .create_screen = pipe_virgl_create_screen,
         .configuration = pipe_default_configuration_query,
@@ -127,6 +132,11 @@ static const struct drm_driver_descriptor driver_descriptors[] = {
         .configuration = pipe_default_configuration_query,
     },
     {
+        .driver_name = "panfrost",
+        .create_screen = pipe_panfrost_create_screen,
+        .configuration = pipe_default_configuration_query,
+    },
+    {
         .driver_name = "etnaviv",
         .create_screen = pipe_etna_create_screen,
         .configuration = pipe_default_configuration_query,
diff --git a/src/gallium/auxiliary/target-helpers/drm_helper.h b/src/gallium/auxiliary/target-helpers/drm_helper.h
index 59ccf98..56c08f6 100644
--- a/src/gallium/auxiliary/target-helpers/drm_helper.h
+++ b/src/gallium/auxiliary/target-helpers/drm_helper.h
@@ -356,6 +356,29 @@ pipe_etna_create_screen(int fd, const struct pipe_screen_config *config)
 
 #endif
 
+#if 0
+#include "panfrost/drm/panfrost_drm_public.h"
+
+struct pipe_screen *
+pipe_panfrost_create_screen(int fd, const struct pipe_screen_config *config)
+{
+   struct pipe_screen *screen;
+
+   screen = panfrost_drm_screen_create(fd);
+   return screen ? debug_screen_wrap(screen) : NULL;
+}
+
+#else
+
+struct pipe_screen *
+pipe_panfrost_create_screen(int fd, const struct pipe_screen_config *config)
+{
+   fprintf(stderr, "panfrost: driver missing\n");
+   return NULL;
+}
+
+#endif
+
 #ifdef GALLIUM_IMX
 #include "imx/drm/imx_drm_public.h"
 
diff --git a/src/gallium/auxiliary/target-helpers/drm_helper_public.h b/src/gallium/auxiliary/target-helpers/drm_helper_public.h
index 5ce6ebc..6d3bc68 100644
--- a/src/gallium/auxiliary/target-helpers/drm_helper_public.h
+++ b/src/gallium/auxiliary/target-helpers/drm_helper_public.h
@@ -43,6 +43,12 @@ struct pipe_screen *
 pipe_vc4_create_screen(int fd, const struct pipe_screen_config *config);
 
 struct pipe_screen *
+pipe_rockchip_create_screen(int fd, const struct pipe_screen_config *config);
+
+struct pipe_screen *
+pipe_panfrost_create_screen(int fd, const struct pipe_screen_config *config);
+
+struct pipe_screen *
 pipe_pl111_create_screen(int fd, const struct pipe_screen_config *config);
 
 struct pipe_screen *
diff --git a/src/gallium/auxiliary/target-helpers/inline_sw_helper.h b/src/gallium/auxiliary/target-helpers/inline_sw_helper.h
index 5bb77a5..0450507 100644
--- a/src/gallium/auxiliary/target-helpers/inline_sw_helper.h
+++ b/src/gallium/auxiliary/target-helpers/inline_sw_helper.h
@@ -18,6 +18,10 @@
 #include "softpipe/sp_public.h"
 #endif
 
+#ifdef GALLIUM_PANFROST
+#include "panfrost/pan_public.h"
+#endif
+
 #ifdef GALLIUM_LLVMPIPE
 #include "llvmpipe/lp_public.h"
 #endif
@@ -55,6 +59,11 @@ sw_screen_create_named(struct sw_winsys *winsys, const char *driver)
       screen = swr_create_screen(winsys);
 #endif
 
+#if defined(GALLIUM_PANFROST)
+   if (screen == NULL && strcmp(driver, "panfrost") == 0)
+      screen = panfrost_create_screen(winsys);
+#endif
+
    return screen;
 }
 
@@ -71,6 +80,8 @@ sw_screen_create(struct sw_winsys *winsys)
    default_driver = "softpipe";
 #elif defined(GALLIUM_SWR)
    default_driver = "swr";
+#elif defined(GALLIUM_PANFROST)
+   default_driver = "panfrost";
 #else
    default_driver = "";
 #endif
diff --git a/src/gallium/auxiliary/target-helpers/sw_helper.h b/src/gallium/auxiliary/target-helpers/sw_helper.h
index 5e4e9f7..3c0d27d 100644
--- a/src/gallium/auxiliary/target-helpers/sw_helper.h
+++ b/src/gallium/auxiliary/target-helpers/sw_helper.h
@@ -24,6 +24,10 @@
 #include "swr/swr_public.h"
 #endif
 
+#ifdef GALLIUM_PANFROST
+#include "panfrost/pan_public.h"
+#endif
+
 #ifdef GALLIUM_VIRGL
 #include "virgl/virgl_public.h"
 #include "virgl/vtest/virgl_vtest_public.h"
@@ -57,6 +61,11 @@ sw_screen_create_named(struct sw_winsys *winsys, const char *driver)
       screen = swr_create_screen(winsys);
 #endif
 
+#if defined(GALLIUM_PANFROST)
+   if (screen == NULL && strcmp(driver, "panfrost") == 0)
+      screen = panfrost_create_screen(-1, (struct renderonly *) winsys);
+#endif
+
    return screen;
 }
 
@@ -73,6 +82,8 @@ sw_screen_create(struct sw_winsys *winsys)
    default_driver = "softpipe";
 #elif defined(GALLIUM_SWR)
    default_driver = "swr";
+#elif defined(GALLIUM_PANFROST)
+   default_driver = "panfrost";
 #else
    default_driver = "";
 #endif
diff --git a/src/gallium/meson.build b/src/gallium/meson.build
index 68f8fa3..3a766f8 100644
--- a/src/gallium/meson.build
+++ b/src/gallium/meson.build
@@ -83,6 +83,12 @@ if with_gallium_freedreno
 else
   driver_freedreno = declare_dependency()
 endif
+if with_gallium_panfrost
+  subdir('winsys/panfrost/drm')
+  subdir('drivers/panfrost')
+else
+  driver_panfrost = declare_dependency()
+endif
 if with_gallium_vc4
   subdir('winsys/vc4/drm')
   subdir('drivers/vc4')
@@ -94,6 +100,11 @@ if with_gallium_pl111
 else
   driver_pl111 = declare_dependency()
 endif
+if with_gallium_rockchip
+  subdir('winsys/rockchip/drm')
+else
+  driver_rockchip = declare_dependency()
+endif
 if with_gallium_v3d
   subdir('winsys/v3d/drm')
   subdir('drivers/v3d')
diff --git a/src/gallium/targets/dri/meson.build b/src/gallium/targets/dri/meson.build
index e2448fc..96049db 100644
--- a/src/gallium/targets/dri/meson.build
+++ b/src/gallium/targets/dri/meson.build
@@ -59,11 +59,12 @@ libgallium_dri = shared_library(
     driver_pl111, driver_v3d, driver_vc4, driver_freedreno, driver_etnaviv,
     driver_imx, driver_tegra, driver_i915, driver_svga, driver_virgl,
     driver_lima, driver_exynos, driver_meson, driver_sun4i, driver_rockchip,
-    driver_swr,
+    driver_swr,driver_panfrost, driver_rockchip
   ],
 )
 
 foreach d : [[with_gallium_pl111, 'pl111_dri.so'],
+             [with_gallium_rockchip, 'rockchip_dri.so'],
              [with_gallium_radeonsi, 'radeonsi_dri.so'],
              [with_gallium_nouveau, 'nouveau_dri.so'],
              [with_gallium_freedreno, ['msm_dri.so', 'kgsl_dri.so']],
@@ -71,6 +72,7 @@ foreach d : [[with_gallium_pl111, 'pl111_dri.so'],
              [with_gallium_softpipe and with_gallium_drisw_kms, 'kms_swrast_dri.so'],
              [with_gallium_v3d, 'v3d_dri.so'],
              [with_gallium_vc4, 'vc4_dri.so'],
+             [with_gallium_panfrost, 'panfrost_dri.so'],
              [with_gallium_etnaviv, 'etnaviv_dri.so'],
              [with_gallium_imx, 'imx-drm_dri.so'],
              [with_gallium_tegra, 'tegra_dri.so'],
diff --git a/src/gallium/targets/dri/target.c b/src/gallium/targets/dri/target.c
index 30a4bc8..cdb8d07 100644
--- a/src/gallium/targets/dri/target.c
+++ b/src/gallium/targets/dri/target.c
@@ -82,6 +82,16 @@ DEFINE_LOADER_DRM_ENTRYPOINT(pl111)
 #endif
 #endif
 
+#if defined(GALLIUM_PANFROST)
+const __DRIextension **__driDriverGetExtensions_panfrost(void);
+
+PUBLIC const __DRIextension **__driDriverGetExtensions_panfrost(void)
+{
+   globalDriverAPI = &galliumsw_driver_api;
+   return galliumsw_driver_extensions;
+}
+#endif
+
 #if defined(GALLIUM_ETNAVIV)
 DEFINE_LOADER_DRM_ENTRYPOINT(imx_drm)
 DEFINE_LOADER_DRM_ENTRYPOINT(etnaviv)
diff --git a/src/glx/drisw_glx.c b/src/glx/drisw_glx.c
index a277710..f9facd2 100644
--- a/src/glx/drisw_glx.c
+++ b/src/glx/drisw_glx.c
@@ -746,7 +746,7 @@ driswDestroyScreen(struct glx_screen *base)
    free(psc);
 }
 
-#define SWRAST_DRIVER_NAME "swrast"
+#define SWRAST_DRIVER_NAME "panfrost"
 
 static void *
 driOpenSwrast(void)
-- 
2.7.4

