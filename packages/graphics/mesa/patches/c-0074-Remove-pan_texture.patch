From c05783580717424f23fda6da707ec38e6a346b0f Mon Sep 17 00:00:00 2001
From: Alyssa Rosenzweig <alyssa@rosenzweig.io>
Date: Tue, 6 Nov 2018 15:50:34 -0800
Subject: [PATCH 074/151] Remove pan_texture

---
 src/gallium/drivers/panfrost/meson.build   |   2 -
 src/gallium/drivers/panfrost/pan_screen.c  |  69 ++++++++++++++++-
 src/gallium/drivers/panfrost/pan_texture.c | 118 -----------------------------
 src/gallium/drivers/panfrost/pan_texture.h |  36 ---------
 4 files changed, 67 insertions(+), 158 deletions(-)
 delete mode 100644 src/gallium/drivers/panfrost/pan_texture.c
 delete mode 100644 src/gallium/drivers/panfrost/pan_texture.h

diff --git a/src/gallium/drivers/panfrost/meson.build b/src/gallium/drivers/panfrost/meson.build
index fb32ef8..975ae37 100644
--- a/src/gallium/drivers/panfrost/meson.build
+++ b/src/gallium/drivers/panfrost/meson.build
@@ -23,8 +23,6 @@ files_panfrost = files(
   'pan_public.h',
   'pan_screen.c',
   'pan_screen.h',
-  'pan_texture.c',
-  'pan_texture.h',
 
   'midgard/midgard_compile.c',
   'midgard/cppwrap.cpp',
diff --git a/src/gallium/drivers/panfrost/pan_screen.c b/src/gallium/drivers/panfrost/pan_screen.c
index a102179..4fa2abd 100644
--- a/src/gallium/drivers/panfrost/pan_screen.c
+++ b/src/gallium/drivers/panfrost/pan_screen.c
@@ -35,8 +35,8 @@
 #include "pipe/p_defines.h"
 #include "pipe/p_screen.h"
 #include "draw/draw_context.h"
+#include "state_tracker/winsys_handle.h"
 
-#include "pan_texture.h"
 #include "pan_screen.h"
 #include "pan_public.h"
 
@@ -550,6 +550,66 @@ panfrost_screen_get_compiler_options(struct pipe_screen *pscreen,
         return &midgard_nir_options;
 }
 
+
+static boolean
+panfrost_can_create_resource(struct pipe_screen *screen,
+                             const struct pipe_resource *res)
+{
+   return TRUE;
+}
+
+static struct pipe_resource *
+panfrost_resource_create(struct pipe_screen *screen,
+                         const struct pipe_resource *templat)
+{
+   return panfrost_resource_create_front(screen, templat, NULL);
+}
+
+static void
+panfrost_resource_destroy(struct pipe_screen *pscreen,
+			  struct pipe_resource *pt)
+{
+   FREE(pt);
+}
+
+static struct pipe_resource *
+panfrost_resource_from_handle(struct pipe_screen *screen,
+                              const struct pipe_resource *templat,
+                              struct winsys_handle *whandle,
+                              unsigned usage)
+{
+	assert(0);
+}
+
+
+static boolean
+panfrost_resource_get_handle(struct pipe_screen *screen,
+                             struct pipe_context *ctx,
+                             struct pipe_resource *pt,
+                             struct winsys_handle *handle,
+                             unsigned usage)
+{
+	struct panfrost_resource *rsrc = (struct panfrost_resource *) pt;
+
+	handle->stride = rsrc->stride;
+
+        /* TODO */
+        assert (0);
+
+	if (handle->type == WINSYS_HANDLE_TYPE_SHARED) {
+		printf("Missed shared handle\n");
+		return FALSE;
+	} else if (handle->type == WINSYS_HANDLE_TYPE_KMS) {
+		printf("Missed nonrenderonly KMS\n");
+		return FALSE;
+	} else if (handle->type == WINSYS_HANDLE_TYPE_FD) {
+		printf("Missed dmabuf\n");
+		return FALSE;
+	}
+
+	return FALSE;
+}
+
 struct pipe_screen *
 panfrost_create_screen(int fd, struct renderonly *ro)
 {
@@ -574,7 +634,12 @@ panfrost_create_screen(int fd, struct renderonly *ro)
    screen->base.fence_reference = panfrost_fence_reference;
    screen->base.fence_finish = panfrost_fence_finish;
 
-   panfrost_init_screen_texture_funcs(&screen->base);
+   screen->base.resource_create = panfrost_resource_create;
+   screen->base.resource_create_front = panfrost_resource_create_front;
+   screen->base.resource_destroy = panfrost_resource_destroy;
+   screen->base.resource_from_handle = panfrost_resource_from_handle;
+   screen->base.resource_get_handle = panfrost_resource_get_handle;
+   screen->base.can_create_resource = panfrost_can_create_resource;
 
    return &screen->base;
 }
diff --git a/src/gallium/drivers/panfrost/pan_texture.c b/src/gallium/drivers/panfrost/pan_texture.c
deleted file mode 100644
index f152b4f..0000000
--- a/src/gallium/drivers/panfrost/pan_texture.c
+++ /dev/null
@@ -1,118 +0,0 @@
-/**************************************************************************
- * 
- * Copyright 2006 VMware, Inc.
- * All Rights Reserved.
- * 
- * Permission is hereby granted, free of charge, to any person obtaining a
- * copy of this software and associated documentation files (the
- * "Software"), to deal in the Software without restriction, including
- * without limitation the rights to use, copy, modify, merge, publish,
- * distribute, sub license, and/or sell copies of the Software, and to
- * permit persons to whom the Software is furnished to do so, subject to
- * the following conditions:
- * 
- * The above copyright notice and this permission notice (including the
- * next paragraph) shall be included in all copies or substantial portions
- * of the Software.
- * 
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
- * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
- * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT.
- * IN NO EVENT SHALL VMWARE AND/OR ITS SUPPLIERS BE LIABLE FOR
- * ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
- * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
- * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
- * 
- **************************************************************************/
- /*
-  * Authors:
-  *   Keith Whitwell <keithw@vmware.com>
-  *   Michel DÃ¤nzer <daenzer@vmware.com>
-  */
-
-#include "pipe/p_defines.h"
-#include "util/u_inlines.h"
-
-#include "util/u_format.h"
-#include "util/u_math.h"
-#include "util/u_memory.h"
-#include "util/u_transfer.h"
-#include "util/u_surface.h"
-
-#include "pan_texture.h"
-#include "pan_screen.h"
-
-#include "renderonly/renderonly.h"
-
-static boolean
-panfrost_can_create_resource(struct pipe_screen *screen,
-                             const struct pipe_resource *res)
-{
-   return TRUE;
-}
-
-#define __PAN_GALLIUM
-#include <pan_context.h>
-
-static struct pipe_resource *
-panfrost_resource_create(struct pipe_screen *screen,
-                         const struct pipe_resource *templat)
-{
-   return panfrost_resource_create_front(screen, templat, NULL);
-}
-
-static void
-panfrost_resource_destroy(struct pipe_screen *pscreen,
-			  struct pipe_resource *pt)
-{
-   FREE(pt);
-}
-
-static struct pipe_resource *
-panfrost_resource_from_handle(struct pipe_screen *screen,
-                              const struct pipe_resource *templat,
-                              struct winsys_handle *whandle,
-                              unsigned usage)
-{
-	assert(0);
-}
-
-
-static boolean
-panfrost_resource_get_handle(struct pipe_screen *screen,
-                             struct pipe_context *ctx,
-                             struct pipe_resource *pt,
-                             struct winsys_handle *handle,
-                             unsigned usage)
-{
-	struct panfrost_resource *rsrc = (struct panfrost_resource *) pt;
-
-	handle->stride = rsrc->stride;
-
-	if (handle->type == WINSYS_HANDLE_TYPE_SHARED) {
-		printf("Missed shared handle\n");
-		return FALSE;
-		//return etna_bo_get_name(rsc->bo, &handle->handle) == 0;
-	} else if (handle->type == WINSYS_HANDLE_TYPE_KMS) {
-		printf("Missed nonrenderonly KMS\n");
-		return FALSE;
-		//handle->handle = etna_bo_handle(rsc->bo);
-	} else if (handle->type == WINSYS_HANDLE_TYPE_FD) {
-		printf("Missed dmabuf\n");
-		return FALSE;
-		//handle->handle = etna_bo_dmabuf(rsc->bo);
-	}
-
-	return FALSE;
-}
-
-void
-panfrost_init_screen_texture_funcs(struct pipe_screen *screen)
-{
-   screen->resource_create = panfrost_resource_create;
-   screen->resource_create_front = panfrost_resource_create_front;
-   screen->resource_destroy = panfrost_resource_destroy;
-   screen->resource_from_handle = panfrost_resource_from_handle;
-   screen->resource_get_handle = panfrost_resource_get_handle;
-   screen->can_create_resource = panfrost_can_create_resource;
-}
diff --git a/src/gallium/drivers/panfrost/pan_texture.h b/src/gallium/drivers/panfrost/pan_texture.h
deleted file mode 100644
index 828c9d4..0000000
--- a/src/gallium/drivers/panfrost/pan_texture.h
+++ /dev/null
@@ -1,36 +0,0 @@
-/**************************************************************************
- * 
- * Copyright 2007 VMware, Inc.
- * All Rights Reserved.
- * 
- * Permission is hereby granted, free of charge, to any person obtaining a
- * copy of this software and associated documentation files (the
- * "Software"), to deal in the Software without restriction, including
- * without limitation the rights to use, copy, modify, merge, publish,
- * distribute, sub license, and/or sell copies of the Software, and to
- * permit persons to whom the Software is furnished to do so, subject to
- * the following conditions:
- * 
- * The above copyright notice and this permission notice (including the
- * next paragraph) shall be included in all copies or substantial portions
- * of the Software.
- * 
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
- * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
- * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT.
- * IN NO EVENT SHALL VMWARE AND/OR ITS SUPPLIERS BE LIABLE FOR
- * ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
- * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
- * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
- * 
- **************************************************************************/
-
-#ifndef SP_TEXTURE_H
-#define SP_TEXTURE_H
-
-#include "pipe/p_state.h"
-
-extern void
-panfrost_init_screen_texture_funcs(struct pipe_screen *screen);
-
-#endif /* SP_TEXTURE */
-- 
2.7.4

